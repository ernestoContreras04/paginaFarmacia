<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Firebase Debug - Farmacia</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .info { background-color: #e3f2fd; border: 1px solid #2196f3; }
        .success { background-color: #e8f5e8; border: 1px solid #4caf50; }
        .error { background-color: #ffebee; border: 1px solid #f44336; }
        .warning { background-color: #fff3e0; border: 1px solid #ff9800; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .log { background-color: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .log-success { border-left-color: #4caf50; }
        .log-error { border-left-color: #f44336; }
        .log-warning { border-left-color: #ff9800; }
        .log-info { border-left-color: #2196f3; }
    </style>
</head>
<body>
    <h1>üß™ Test Firebase Debug - Farmacia</h1>
    <p>Esta p√°gina hace pruebas paso a paso de Firebase para identificar el problema.</p>

    <div id="status" class="status info">Esperando...</div>

    <div>
        <button onclick="testFirebaseInit()">1. Probar Inicializaci√≥n Firebase</button>
        <button onclick="testFirestoreConnection()">2. Probar Conexi√≥n Firestore</button>
        <button onclick="testDatabaseAccess()">3. Probar Acceso a Base de Datos</button>
        <button onclick="testCollectionAccess()">4. Probar Acceso a Colecci√≥n</button>
        <button onclick="testProductLoading()">5. Probar Carga de Productos</button>
        <button onclick="clearLog()">Limpiar Log</button>
    </div>

    <div id="log" class="log"></div>

    <!-- Firebase SDK v9+ (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, connectFirestoreEmulator, collection, getDocs, limit, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDnGAwyCaGqSxhDX8woS9nbR-1kGc5D360",
            authDomain: "farmacia-9737f.firebaseapp.com",
            projectId: "farmacia-9737f",
            storageBucket: "farmacia-9737f.firebasestorage.app",
            messagingSenderId: "265524327894",
            appId: "1:265524327894:web:2b8f935db21ddf24362077",
            measurementId: "G-T5V39CTSDF"
        };

        let app, db, productsCollection;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            updateStatus('Log limpiado', 'info');
        }

        async function testFirebaseInit() {
            try {
                log('üîÑ Iniciando prueba de inicializaci√≥n de Firebase...', 'info');
                updateStatus('Probando inicializaci√≥n...', 'info');

                app = initializeApp(firebaseConfig);
                log('‚úÖ Firebase app inicializado:', 'success');
                log(`   - Project ID: ${app.options.projectId}`, 'info');

                updateStatus('Firebase inicializado correctamente', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Error al inicializar Firebase: ${error.message}`, 'error');
                updateStatus('Error en inicializaci√≥n', 'error');
                return false;
            }
        }

        async function testFirestoreConnection() {
            try {
                log('üîÑ Probando conexi√≥n a Firestore...', 'info');
                updateStatus('Probando conexi√≥n Firestore...', 'info');

                // Inicializar Firestore con la base de datos 'farmacia'
                db = getFirestore(app, 'farmacia');
                log('‚úÖ Firestore inicializado con base de datos "farmacia"', 'success');

                // Verificar configuraci√≥n
                log(`   - Project ID: ${app.options.projectId}`, 'info');
                
                updateStatus('Firestore conectado a base de datos "farmacia"', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Error al conectar Firestore: ${error.message}`, 'error');
                updateStatus('Error en conexi√≥n Firestore', 'error');
                return false;
            }
        }

        async function testDatabaseAccess() {
            try {
                log('üîÑ Probando acceso a la base de datos...', 'info');
                updateStatus('Probando acceso a BD...', 'info');

                // Intentar una operaci√≥n simple para verificar la conexi√≥n
                const testCollection = collection(db, 'test');
                const testDoc = doc(testCollection, 'connection-test');
                await getDoc(testDoc);
                log('‚úÖ Acceso a base de datos exitoso', 'success');
                
                updateStatus('Acceso a BD exitoso', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Error al acceder a la base de datos: ${error.message}`, 'error');
                log(`   - C√≥digo: ${error.code}`, 'warning');
                log(`   - Tipo: ${error.name}`, 'warning');
                updateStatus('Error en acceso a BD', 'error');
                return false;
            }
        }

        async function testCollectionAccess() {
            try {
                log('üîÑ Probando acceso a la colecci√≥n productos...', 'info');
                updateStatus('Probando acceso a colecci√≥n...', 'info');

                productsCollection = collection(db, 'productos');
                log('‚úÖ Colecci√≥n productos configurada', 'success');

                // Intentar obtener un documento de prueba (sin limit para simplificar)
                const snapshot = await getDocs(productsCollection);
                log(`‚úÖ Acceso a colecci√≥n exitoso - ${snapshot.docs.length} documentos encontrados`, 'success');

                updateStatus('Acceso a colecci√≥n exitoso', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Error al acceder a la colecci√≥n: ${error.message}`, 'error');
                log(`   - C√≥digo: ${error.code}`, 'warning');
                updateStatus('Error en acceso a colecci√≥n', 'error');
                return false;
            }
        }

        async function testProductLoading() {
            try {
                log('üîÑ Probando carga completa de productos...', 'info');
                updateStatus('Probando carga de productos...', 'info');

                const snapshot = await getDocs(productsCollection);
                const products = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.Nombre || data.name || 'Sin nombre',
                        description: data.Descripcion || data.description || 'Sin descripci√≥n',
                        price: data.Precio || data.price || 0,
                        category: data.Tipo || data.category || 'Sin categor√≠a',
                        brand: data.Marca || data.brand || 'Sin marca',
                        image: data.ruta_imagen || data.image || 'üíä'
                    };
                });

                log(`‚úÖ Productos cargados exitosamente: ${products.length}`, 'success');
                
                if (products.length > 0) {
                    products.forEach(product => {
                        log(`   üì¶ ${product.name} - ‚Ç¨${product.price}`, 'info');
                    });
                }

                updateStatus(`Productos cargados: ${products.length}`, 'success');
                return true;

            } catch (error) {
                log(`‚ùå Error al cargar productos: ${error.message}`, 'error');
                log(`   - C√≥digo: ${error.code}`, 'warning');
                updateStatus('Error al cargar productos', 'error');
                return false;
            }
        }

        // Hacer las funciones disponibles globalmente
        window.testFirebaseInit = testFirebaseInit;
        window.testFirestoreConnection = testFirestoreConnection;
        window.testDatabaseAccess = testDatabaseAccess;
        window.testCollectionAccess = testCollectionAccess;
        window.testProductLoading = testProductLoading;
        window.clearLog = clearLog;

        document.addEventListener('DOMContentLoaded', function() {
            log('üì± P√°gina cargada. Lista para probar Firebase paso a paso.', 'info');
            updateStatus('Listo para probar', 'info');
        });
    </script>
</body>
</html>
